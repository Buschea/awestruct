#!/usr/bin/env jruby

$: << File.dirname(__FILE__) + '/../lib'

require 'rubygems'
require 'hekyll'
require 'mongrel'

server = Mongrel::HttpServer.new("0.0.0.0", 4242)


engine = Hekyll::Engine.new( Dir.pwd ) 
engine.generate

Thread.new(engine) do |engine|
  while ( true ) 
    sleep(1)
    begin
      engine.generate
    rescue => e 
      puts "error: #{e}"
    end
  end
end

handler = Mongrel::DirHandler.new( File.join( Dir.pwd, '_site' ) )
#Mongrel::DirHandler::MIME_TYPES['.atom'] = 'text/plain'
Mongrel::DirHandler::MIME_TYPES['.atom'] = 'application/atom+xml'
server.register("/", handler )
$stderr.puts "Server running"
server.run.join

